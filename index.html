<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SOX GCC Delivery Dashboard</title>
  <style>
    :root {
      --lowes-blue: #004990;
      --lowes-white: #FFFFFF;
      --lowes-light-blue: #15b6e5;
      --lowes-gray: #f5f7fa;
      --lowes-dark-blue: #002f60;
      --radius-base: 12px;
      --font-family: "Segoe UI", "Inter", Arial, sans-serif;
      --font-size-base: 16px;
      --shadow-sm: 0 2px 8px rgba(0, 73, 144, 0.08);
      --shadow-md: 0 4px 16px rgba(0, 73, 144, 0.12);
      --shadow-lg: 0 8px 32px rgba(0, 73, 144, 0.16);
    }
    
    * {
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
      margin: 0;
      font-family: var(--font-family);
      background: linear-gradient(135deg, #f5f7fa 0%, #e8eef5 100%);
      color: var(--lowes-blue);
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    header {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      background: linear-gradient(135deg, var(--lowes-blue) 0%, var(--lowes-dark-blue) 100%);
      padding: 24px 32px;
      border-radius: var(--radius-base);
      box-shadow: var(--shadow-lg);
      margin-bottom: 2.5rem;
      position: relative;
      overflow: hidden;
    }
    
    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.05) 50%, transparent 70%);
      animation: shimmer 3s infinite;
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    .sync-btn, .save-excel-btn {
      position: absolute;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.3);
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 600;
      transition: all 0.3s;
      backdrop-filter: blur(10px);
      z-index: 2;
    }
    
    .sync-btn {
      right: 32px;
    }
    
    .save-excel-btn {
      right: 180px;
    }
    
    .sync-btn:hover, .save-excel-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-2px);
    }
    
    #excelFileInput {
      display: none;
    }
    
    .save-notification {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(76, 175, 80, 0.4);
      font-weight: 600;
      z-index: 10000;
      display: none;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .header-content {
      display: flex;
      align-items: center;
      gap: 20px;
      position: relative;
      z-index: 1;
    }
    
    .logo {
      width: 100px;
      height: 45px;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }
    
    .dashboard-title {
      font-size: 2.2rem;
      font-weight: 700;
      color: var(--lowes-white);
      letter-spacing: 1.2px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .summary-boxes {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2.5rem;
    }
    
    .summary-box {
      background: linear-gradient(135deg, var(--lowes-white) 0%, #f8fbff 100%);
      border-radius: var(--radius-base);
      padding: 20px 24px;
      box-shadow: var(--shadow-md);
      display: flex;
      flex-direction: column;
      gap: 8px;
      border-top: 4px solid var(--lowes-blue);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .summary-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, transparent 0%, rgba(21, 182, 229, 0.03) 100%);
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .summary-box:hover::before {
      opacity: 1;
    }
    
    .summary-box.completed {
      background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
      border-top: 4px solid #4caf50;
      box-shadow: 0 4px 16px rgba(76, 175, 80, 0.25), 0 0 24px rgba(76, 175, 80, 0.12);
    }
    
    .summary-box.completed .summary-value {
      color: #2e7d32;
    }
    
    .summary-box.in-progress {
      background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
      border-top: 4px solid #ff9800;
      box-shadow: 0 4px 16px rgba(255, 152, 0, 0.25), 0 0 24px rgba(255, 152, 0, 0.12);
    }
    
    .summary-box.in-progress .summary-value {
      color: #e65100;
    }
    
    .summary-box:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: var(--shadow-lg);
    }
    
    .summary-value {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--lowes-blue);
      line-height: 1;
    }
    
    .summary-label {
      font-size: 0.9rem;
      color: var(--lowes-dark-blue);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .filters {
      display: flex;
      gap: 1.5rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }
    
    .filter-group {
      background: var(--lowes-white);
      padding: 16px 24px;
      border-radius: var(--radius-base);
      box-shadow: var(--shadow-sm);
      display: flex;
      flex-direction: column;
      gap: 10px;
      border-bottom: 3px solid var(--lowes-light-blue);
      transition: all 0.3s;
      flex: 1;
      min-width: 180px;
    }
    
    .filter-group:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }
    
    label {
      font-size: 0.9em;
      color: var(--lowes-dark-blue);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    select, input[type="date"], input[type="text"] {
      padding: 8px 14px;
      border-radius: 8px;
      border: 2px solid #e0e7ef;
      background: var(--lowes-white);
      color: var(--lowes-dark-blue);
      font-size: var(--font-size-base);
      transition: all 0.3s;
      font-family: var(--font-family);
    }
    
    select:focus, input[type="date"]:focus, input[type="text"]:focus {
      outline: none;
      border-color: var(--lowes-light-blue);
      box-shadow: 0 0 0 3px rgba(21, 182, 229, 0.1);
    }
    
    .controls-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: var(--lowes-white);
      border-radius: var(--radius-base);
      overflow: hidden;
      box-shadow: var(--shadow-md);
    }
    
    .controls-table th,
    .controls-table td {
      padding: 16px 18px;
      text-align: left;
      border-bottom: 1px solid #edf2f7;
      font-size: 1em;
    }
    
    .controls-table tbody tr {
      transition: all 0.2s;
    }
    
    .controls-table tbody tr:hover {
      background: linear-gradient(90deg, #f8fbff 0%, #f0f7ff 100%);
      transform: scale(1.001);
    }
    
    .controls-table tbody tr:last-child td {
      border-bottom: none;
    }
    
    .delayed {
      background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
      color: #c62828;
      font-weight: 700;
      padding: 4px 8px;
      border-radius: 6px;
      display: inline-block;
    }
    
    .controls-table th {
      background: linear-gradient(135deg, var(--lowes-blue) 0%, var(--lowes-dark-blue) 100%);
      color: var(--lowes-white);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.9em;
      position: sticky;
      top: 0;
      z-index: 10;
      cursor: pointer;
      user-select: none;
    }
    
    .controls-table th.sortable {
      position: relative;
      padding-right: 30px;
    }
    
    .controls-table th.sortable:hover {
      background: linear-gradient(135deg, #005aa7 0%, #003d70 100%);
    }
    
    .sort-icon {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 2px;
      opacity: 0.4;
      transition: opacity 0.2s;
    }
    
    .sort-icon.active {
      opacity: 1;
    }
    
    .sort-arrow {
      width: 0;
      height: 0;
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
    }
    
    .sort-arrow.up {
      border-bottom: 6px solid currentColor;
    }
    
    .sort-arrow.down {
      border-top: 6px solid currentColor;
    }
    
    .sort-arrow.active {
      opacity: 1;
      color: var(--lowes-light-blue);
    }
    
    .edit-btn {
      background: linear-gradient(135deg, var(--lowes-light-blue) 0%, #0d9bc7 100%);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 600;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(21, 182, 229, 0.3);
    }
    
    .edit-btn:hover {
      background: linear-gradient(135deg, var(--lowes-blue) 0%, var(--lowes-dark-blue) 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 73, 144, 0.4);
    }
    
    .edit-btn:active {
      transform: translateY(0);
    }
    
    .progress-bar-wrapper {
      background: #e8eef5;
      border-radius: 12px;
      height: 28px;
      width: 100%;
      display: flex;
      align-items: center;
      position: relative;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
    }
    
    .progress-bar {
      height: 100%;
      border-radius: 12px;
      transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      background: linear-gradient(90deg, var(--lowes-blue) 0%, var(--lowes-light-blue) 100%);
      position: relative;
      overflow: hidden;
    }
    
    .progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
      animation: progress-shine 2s infinite;
    }
    
    @keyframes progress-shine {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    .progress-text {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      font-weight: 700;
      font-size: 0.85em;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    /* ==================== ANALYTICS SECTION ==================== */
    .analytics-section {
      margin-top: 2.5rem;
      margin-bottom: 2.5rem;
    }
    
    .analytics-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
    }
    
    .analytics-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--lowes-blue);
    }
    
    .analytics-toggle {
      display: flex;
      background: #e8eef5;
      border-radius: 8px;
      padding: 4px;
    }
    
    .analytics-toggle button {
      padding: 8px 16px;
      border: none;
      background: transparent;
      color: var(--lowes-dark-blue);
      font-weight: 600;
      font-size: 0.85em;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.3s;
    }
    
    .analytics-toggle button.active {
      background: var(--lowes-blue);
      color: white;
      box-shadow: 0 2px 8px rgba(0, 73, 144, 0.3);
    }
    
    .analytics-toggle button:hover:not(.active) {
      background: rgba(0, 73, 144, 0.1);
    }
    
    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr) 2fr;
      gap: 1.5rem;
    }
    
    .analytics-card {
      background: var(--lowes-white);
      border-radius: var(--radius-base);
      padding: 20px;
      box-shadow: var(--shadow-sm);
      border-top: 3px solid var(--lowes-blue);
    }
    
    .analytics-card-title {
      font-size: 0.8rem;
      color: var(--lowes-dark-blue);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }
    
    .donut-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }
    
    .donut-chart {
      position: relative;
      width: 90px;
      height: 90px;
    }
    
    .donut-chart svg {
      transform: rotate(-90deg);
    }
    
    .donut-chart circle {
      fill: none;
      stroke-width: 8;
    }
    
    .donut-bg {
      stroke: #e8eef5;
    }
    
    .donut-progress {
      stroke-linecap: round;
      transition: stroke-dashoffset 0.6s ease;
    }
    
    .donut-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }
    
    .donut-value {
      font-size: 1.4rem;
      font-weight: 800;
      color: var(--lowes-blue);
      line-height: 1;
    }
    
    .donut-label {
      font-size: 0.65rem;
      color: #666;
      margin-top: 2px;
    }
    
    .donut-legend {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 0.8rem;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    
    .timeline-chart {
      height: 180px;
      position: relative;
    }
    
    .timeline-svg {
      width: 100%;
      height: 100%;
    }
    
    .timeline-grid-line {
      stroke: #e8eef5;
      stroke-width: 1;
    }
    
    .timeline-axis-label {
      font-size: 9px;
      fill: #666;
    }
    
    .timeline-line {
      fill: none;
      stroke-width: 2.5;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    
    .timeline-dot {
      transition: r 0.2s;
      cursor: pointer;
    }
    
    .timeline-dot:hover {
      r: 5;
    }
    
    .timeline-legend {
      display: flex;
      justify-content: center;
      gap: 24px;
      margin-top: 12px;
      font-size: 0.8rem;
    }
    
    .timeline-legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .timeline-legend-line {
      width: 20px;
      height: 3px;
      border-radius: 2px;
    }
    
    @media (max-width: 900px) {
      .analytics-grid {
        grid-template-columns: 1fr;
      }
      .analytics-header {
        flex-direction: column;
        gap: 12px;
        align-items: flex-start;
      }
    }
    /* ==================== END ANALYTICS SECTION ==================== */

    /* ==================== OBSERVATIONS SECTION ==================== */
    .observations-section {
      margin-top: 2.5rem;
      margin-bottom: 2.5rem;
    }
    
    .observations-header {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .observations-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--lowes-blue);
    }
    
    .observations-container {
      background: var(--lowes-white);
      border-radius: var(--radius-base);
      padding: 20px 24px;
      box-shadow: var(--shadow-sm);
      border-left: 4px solid #ff9800;
    }
    
    .observation-item {
      padding: 12px 0;
      border-bottom: 1px solid #edf2f7;
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }
    
    .observation-item:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }
    
    .observation-item:first-child {
      padding-top: 0;
    }
    
    .observation-bullet {
      width: 8px;
      height: 8px;
      min-width: 8px;
      background: #ff9800;
      border-radius: 50%;
      margin-top: 6px;
    }
    
    .observation-content {
      flex: 1;
    }
    
    .observation-control {
      font-weight: 700;
      color: var(--lowes-blue);
      font-size: 0.95rem;
      margin-bottom: 4px;
    }
    
    .observation-text {
      color: var(--lowes-dark-blue);
      font-size: 0.9rem;
      line-height: 1.5;
    }
    
    .observation-tag {
      display: inline-block;
      background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
      color: #e65100;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 4px;
      margin-right: 8px;
      text-transform: uppercase;
    }
    
    .no-observations {
      color: #666;
      font-style: italic;
      text-align: center;
      padding: 20px;
    }
    /* ==================== END OBSERVATIONS SECTION ==================== */

    .milestones {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-top: 2.5rem;
    }
    
    .milestone-card {
      background: linear-gradient(135deg, var(--lowes-white) 0%, #f8fbff 100%);
      border-radius: var(--radius-base);
      padding: 20px;
      box-shadow: var(--shadow-md);
      display: flex;
      flex-direction: column;
      gap: 10px;
      border-left: 5px solid var(--lowes-blue);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .milestone-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, transparent 0%, rgba(21, 182, 229, 0.05) 100%);
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .milestone-card:hover::before {
      opacity: 1;
    }
    
    .milestone-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }
    
    .milestone-date {
      font-size: 1.15em;
      color: var(--lowes-blue);
      font-weight: 700;
    }
    
    .milestone-label {
      color: var(--lowes-dark-blue);
      font-size: 0.85em;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    #editPanel {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 20px 60px rgba(0,73,144,0.3);
      z-index: 1000;
      min-width: 450px;
      max-width: 90vw;
    }
    
    #editPanel h3 {
      margin-top: 0;
      color: var(--lowes-blue);
      font-size: 1.5rem;
      font-weight: 700;
    }
    
    #editPanel .input-group {
      margin-bottom: 20px;
    }
    
    #editPanel label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 0.9em;
    }
    
    #editPanel input,
    #editPanel select {
      width: 100%;
      padding: 10px 14px;
      border: 2px solid #e0e7ef;
      border-radius: 8px;
      font-size: 1em;
    }
    
    #editPanel .button-group {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
    }
    
    #editPanel button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1em;
      transition: all 0.3s;
    }
    
    #editPanel .cancel-btn {
      background: #e0e7ef;
      color: var(--lowes-dark-blue);
    }
    
    #editPanel .cancel-btn:hover {
      background: #d0d7df;
    }
    
    #editPanel .save-btn {
      background: linear-gradient(135deg, var(--lowes-blue) 0%, var(--lowes-dark-blue) 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(0, 73, 144, 0.3);
    }
    
    #editPanel .save-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 73, 144, 0.4);
    }
    
    #editOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 47, 96, 0.6);
      backdrop-filter: blur(4px);
      z-index: 999;
    }
    
    @media (max-width: 900px) {
      .container { padding: 1rem; }
      .dashboard-title { font-size: 1.5rem; }
      .summary-boxes { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
      .filters { flex-direction: column; }
      #editPanel { min-width: 90vw; padding: 24px; }
    }
  </style>
  <!-- SheetJS library for Excel read/write -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body>
  <header>
    <div class="header-content">
      <img src="https://www.lowescdn.com/images/logos/lowes_logo_white.png" alt="Lowe's Logo" class="logo">
      <span class="dashboard-title">SOX GCC Delivery Dashboard</span>
    </div>
    <button class="sync-btn" onclick="document.getElementById('excelFileInput').click()" title="Load data from Excel file">üìÇ Load Excel</button>
    <button class="save-excel-btn" onclick="downloadExcel()" title="Save data to Excel file">üíæ Save Excel</button>
    <input type="file" id="excelFileInput" accept=".xlsx,.xls" onchange="handleExcelFileSelect(event)" />
  </header>
  
  <div class="container">
    <section class="summary-boxes" id="summaryBoxes"></section>

    <form id="filters" class="filters" autocomplete="off">
      <div class="filter-group">
        <label for="nameFilter">Control Name</label>
        <input type="text" id="nameFilter" placeholder="Search control name..." />
      </div>
      <div class="filter-group">
        <label for="controlTypeFilter">Control Type</label>
        <select id="controlTypeFilter" name="controlType">
          <option value="All">All</option>
          <option value="Reliance">Reliance</option>
          <option value="Independent">Independent</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="dateFilter">Completion Date Before</label>
        <input type="date" id="dateFilter" name="dateFilter" />
      </div>
      <div class="filter-group">
        <label for="progressFilter">Completion ‚â•</label>
        <select id="progressFilter">
          <option value="0">0%</option>
          <option value="0.25">25%</option>
          <option value="0.5">50%</option>
          <option value="0.75">75%</option>
          <option value="1">100%</option>
        </select>
      </div>
    </form>

    <table class="controls-table" id="controlsTable">
      <thead>
        <tr>
          <th>Control Name</th>
          <th>Type</th>
          <th>Completion Date</th>
          <th class="sortable" onclick="sortByProgress()">
            Progress
            <span class="sort-icon" id="sortIcon">
              <span class="sort-arrow up"></span>
              <span class="sort-arrow down"></span>
            </span>
          </th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- ==================== ANALYTICS SECTION ==================== -->
    <section class="analytics-section" id="analyticsSection">
      <div class="analytics-header">
        <span class="analytics-title">üìä Analytics</span>
        <div class="analytics-toggle">
          <button class="active" onclick="setAnalyticsView('all')">All</button>
          <button onclick="setAnalyticsView('reliance')">Reliance</button>
          <button onclick="setAnalyticsView('independent')">Independent</button>
        </div>
      </div>
      <div class="analytics-grid">
        <div class="analytics-card">
          <div class="analytics-card-title">Reliance Controls</div>
          <div class="donut-container" id="relianceDonut"></div>
        </div>
        <div class="analytics-card">
          <div class="analytics-card-title">Independent Controls</div>
          <div class="donut-container" id="independentDonut"></div>
        </div>
        <div class="analytics-card">
          <div class="analytics-card-title">Delivery Timeline (Expected vs Actual)</div>
          <div class="timeline-chart" id="timelineChart"></div>
          <div class="timeline-legend">
            <div class="timeline-legend-item">
              <div class="timeline-legend-line" style="background: var(--lowes-blue);"></div>
              <span>Expected</span>
            </div>
            <div class="timeline-legend-item">
              <div class="timeline-legend-line" style="background: #4caf50;"></div>
              <span>Actual Completed</span>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- ==================== END ANALYTICS SECTION ==================== -->

    <!-- ==================== OBSERVATIONS SECTION ==================== -->
    <section class="observations-section" id="observationsSection">
      <div class="observations-header">
        <span class="observations-title">‚ö†Ô∏è Process Improvement</span>
      </div>
      <div class="observations-container" id="observationsContainer">
        <!-- Observations will be rendered here -->
      </div>
    </section>
    <!-- ==================== END OBSERVATIONS SECTION ==================== -->

    <section class="milestones" id="milestonesSection"></section>
    
    <div id="editPanel">
      <h3>Edit Control</h3>
      <input type="hidden" id="editIndex" />
      <div class="input-group">
        <label>Control Name</label>
        <input type="text" id="editName" />
      </div>
      <div class="input-group">
        <label>Type</label>
        <select id="editType">
          <option value="Reliance">Reliance</option>
          <option value="Independent">Independent</option>
        </select>
      </div>
      <div class="input-group">
        <label>Completion Date</label>
        <input type="date" id="editDate" />
      </div>
      <div class="input-group">
        <label>Progress (%)</label>
        <input type="number" id="editProgress" min="0" max="100" />
      </div>
      <div class="button-group">
        <button type="button" class="cancel-btn" onclick="closeEditPanel()">Cancel</button>
        <button type="button" class="save-btn" onclick="saveEdit()">Save</button>
      </div>
    </div>
    <div id="editOverlay" onclick="closeEditPanel()"></div>
    
    <div id="saveNotification" class="save-notification">
      ‚úì Changes saved successfully!
    </div>
  </div>

  <script>
    // Default controls data
    const defaultControls = [
      {name:"AC7.2 Emergency ID Provisioning",type:"Reliance",date:"2025-11-21",progress:1.0},
      {name:"AC9.1 - User Provisioning",type:"Reliance",date:"2026-01-28",progress:0.3},
      {name:"AC9.4 - Employee Transfers",type:"Independent",date:"2025-11-28",progress:1.0},
      {name:"AC11.1 - Terminations Standard Automated Process",type:"Reliance",date:"2025-12-12",progress:0.0},
      {name:"AC11.3 - Inactive User Account Maintenance",type:"Reliance",date:"2025-12-05",progress:1.0},
      {name:"AC11.4 - IT Contractor Terminations",type:"Reliance",date:"2025-12-12",progress:0.7},
      {name:"AC16.5 - Review of Access for Direct Changes to SOX Distributed Databases",type:"Independent",date:"2026-01-09",progress:0.7},
      {name:"AC16.7 - CVS SOD Review",type:"Independent",date:"2025-12-19",progress:1.0},
      {name:"AC19.1 - Elevated Access",type:"Independent",date:"2026-01-09",progress:0.85},
      {name:"AC20.4 - Review of Access for Direct Changes to SOX Distributed Databases",type:"Independent",date:"2026-01-09",progress:0.85},
      {name:"AC19.5 - Elevated Access - Validation of Elevated Access Scope for Certifications",type:"Reliance",date:"2025-12-26",progress:0.0},
      {name:"CM12.2 - SOX Application Password Configuration Settings",type:"Reliance",date:"2026-01-28",progress:1.0},
      {name:"CM16.5 - Bitbucket Pull Request Master Configuration Enabled",type:"Reliance",date:"2026-01-16",progress:0.0},
      {name:"CC 1.6 - Application Change Review Workday",type:"Reliance",date:"2025-12-19",progress:1.0},
      {name:"CC 1.6 - Application Change Review LX",type:"Reliance",date:"2025-12-26",progress:0.0},
      {name:"CC 1.3 - Change Management",type:"Independent",date:"2026-01-28",progress:0.0},
      {name:"CC 06.6 - DBA Direct Data Changes Made to Teradata and DB2 for zOS Are Reviewed",type:"Independent",date:"2025-12-12",progress:1.0},
      {name:"CO 5.2 - Production Infrastructure Storage, Database Backup and Restoration",type:"Reliance",date:"2025-11-28",progress:1.0},
      {name:"CO2.1 - Production Mainframe Job Monitoring",type:"Reliance",date:"2025-12-19",progress:1.0},
      {name:"CO02.4 ERP to FDI alert mechanism",type:"Independent",date:"2026-01-09",progress:0.0},
      {name:"CO2.3 - Production Job Monitoring - Distributed",type:"Independent",date:"2026-01-16",progress:0.3},
      {name:"CO02.5 - Sail Point Batch Monitoring",type:"Reliance",date:"2025-12-26",progress:0.0},
      {name:"MC 1.5 - Security Incident Event Management Review",type:"Reliance",date:"2025-12-19",progress:0.0},
      {name:"SD01.1 - System Development - Project Selection ",type:"Independent",date:"2025-12-12",progress:1.0},
      {name:"SD01.2 - System Development - Stage Gates",type:"Independent",date:"2026-01-16",progress:0.0},
      {name:"MC20.2 - Review of Controls",type:"Independent",date:"2025-11-21",progress:1.0}
    ];
    
    // Load controls from localStorage or use default
    let controls = loadControls();
    let sortOrder = null; // null, 'asc', 'desc'
    
    // ==================== OBSERVATIONS DATA ====================
    const defaultObservations = [
      {
        control: "CO5.2 Backup monitoring",
        observation: "MongoDB ‚Äì EventStore (21 TB Dataset): Daily cron job was disabled due to excessive runtime (2‚Äì3 days) causing overlaps. Interim: Backup frequency changed to every 72 hours. Long-term: Dataset being split into smaller volumes post-BFCM to reschedule daily backup runs."
      }
    ];
    
    let observations = loadObservations();
    
    function loadObservations() {
      const saved = localStorage.getItem('soxObservations');
      if (saved) {
        try {
          return JSON.parse(saved);
        } catch (e) {
          console.error('Error loading saved observations, using defaults');
          return [...defaultObservations];
        }
      }
      return [...defaultObservations];
    }
    
    function saveObservations() {
      try {
        localStorage.setItem('soxObservations', JSON.stringify(observations));
      } catch (e) {
        console.error('Error saving observations:', e);
      }
    }
    
    function renderObservations() {
      const container = document.getElementById('observationsContainer');
      
      if (observations.length === 0) {
        container.innerHTML = '<div class="no-observations">No observations recorded.</div>';
        return;
      }
      
      container.innerHTML = observations.map((obs, index) => `
        <div class="observation-item">
          <div class="observation-bullet"></div>
          <div class="observation-content">
            <div class="observation-control">
              <span class="observation-tag">Observation</span>
              ${obs.control}
            </div>
            <div class="observation-text">${obs.observation}</div>
          </div>
        </div>
      `).join('');
    }
    // ==================== END OBSERVATIONS DATA ====================
    
    function loadControls() {
      const saved = localStorage.getItem('soxControls');
      if (saved) {
        try {
          return JSON.parse(saved);
        } catch (e) {
          console.error('Error loading saved data, using defaults');
          return [...defaultControls];
        }
      }
      return [...defaultControls];
    }
    
    function saveControls() {
      try {
        localStorage.setItem('soxControls', JSON.stringify(controls));
        showSaveNotification();
        console.log('‚úì Changes saved successfully');
      } catch (e) {
        console.error('Error saving data:', e);
        alert('Error saving data. Please try again.');
      }
    }
    
    function showSaveNotification() {
      const notification = document.getElementById('saveNotification');
      notification.style.display = 'block';
      setTimeout(() => {
        notification.style.display = 'none';
      }, 2000);
    }
    
    function percent(num) { return Math.round(num * 100) + "%"; }

    function renderSummary() {
      const total = controls.length;
      const completed = controls.filter(c => c.progress === 1).length;
      const inProgress = controls.filter(c => c.progress > 0 && c.progress < 1).length;
      const reliance = controls.filter(c => c.type === "Reliance").length;
      const independent = controls.filter(c => c.type === "Independent").length;
      
      const section = document.getElementById("summaryBoxes");
      section.innerHTML = `
        <div class="summary-box">
          <div class="summary-value">${total}</div>
          <div class="summary-label">Total Controls</div>
        </div>
        <div class="summary-box completed">
          <div class="summary-value">${completed}</div>
          <div class="summary-label">Completed</div>
        </div>
        <div class="summary-box in-progress">
          <div class="summary-value">${inProgress}</div>
          <div class="summary-label">In Progress</div>
        </div>
        <div class="summary-box">
          <div class="summary-value">${reliance}</div>
          <div class="summary-label">Reliance Controls</div>
        </div>
        <div class="summary-box">
          <div class="summary-value">${independent}</div>
          <div class="summary-label">Independent Controls</div>
        </div>
      `;
    }

    function getFilteredControls() {
      const nameVal = document.getElementById('nameFilter').value.toLowerCase();
      const typeVal = document.getElementById('controlTypeFilter').value;
      const dateVal = document.getElementById('dateFilter').value;
      const progressVal = parseFloat(document.getElementById('progressFilter').value);

      let filtered = controls.filter(c => {
        let nameMatch = (!nameVal || c.name.toLowerCase().includes(nameVal));
        let typeMatch = (typeVal === "All" || c.type === typeVal);
        let dateMatch = (!dateVal || c.date <= dateVal);
        let progMatch = (typeof c.progress === "number" ? c.progress >= progressVal : true);
        return nameMatch && typeMatch && dateMatch && progMatch;
      });
      
      // Apply sorting if active
      if (sortOrder === 'asc') {
        filtered.sort((a, b) => a.progress - b.progress);
      } else if (sortOrder === 'desc') {
        filtered.sort((a, b) => b.progress - a.progress);
      }
      
      return filtered;
    }
    
    function sortByProgress() {
      if (sortOrder === null) {
        sortOrder = 'desc';
      } else if (sortOrder === 'desc') {
        sortOrder = 'asc';
      } else {
        sortOrder = null;
      }
      
      updateSortIcon();
      renderTable();
    }
    
    function updateSortIcon() {
      const icon = document.getElementById('sortIcon');
      const upArrow = icon.querySelector('.up');
      const downArrow = icon.querySelector('.down');
      
      icon.classList.remove('active');
      upArrow.classList.remove('active');
      downArrow.classList.remove('active');
      
      if (sortOrder === 'asc') {
        icon.classList.add('active');
        upArrow.classList.add('active');
      } else if (sortOrder === 'desc') {
        icon.classList.add('active');
        downArrow.classList.add('active');
      }
    }

    function renderTable() {
      const data = getFilteredControls();
      const tbody = document.getElementById("controlsTable").querySelector("tbody");
      const today = new Date().toISOString().split('T')[0];
      tbody.innerHTML = '';
      
      data.forEach((c, idx) => {
        const isDelayed = c.date < today && c.progress < 1;
        const tr = document.createElement("tr");
        const progressPercent = Math.round(c.progress * 100);
        const progressColor = c.progress === 1 ? '#4caf50' : '#004990';
        
        tr.innerHTML = `
          <td>${c.name}</td>
          <td>${c.type}</td>
          <td>${isDelayed ? '<span class="delayed">' + c.date + ' ‚ö† DELAYED</span>' : c.date}</td>
          <td>
            <div class="progress-bar-wrapper">
              <div class="progress-bar" style="width:${Math.max(5, progressPercent)}%;"></div>
              <span class="progress-text" style="color:${progressColor};">${percent(c.progress)}</span>
            </div>
          </td>
          <td>
            <button class="edit-btn" onclick="openEditPanel(${controls.indexOf(c)})">Edit</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderMilestones() {
      const completed = controls.filter(c => c.progress === 1);
      const today = new Date().toISOString().split('T')[0];
      const fourteenDaysLater = new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
      const upcoming = controls.filter(c => c.date >= today && c.date <= fourteenDaysLater && c.progress < 1)
                               .sort((a,b) => a.date.localeCompare(b.date));
      const maxIncomplete = [...controls].filter(c=>c.progress<1).sort((a,b) => b.progress-a.progress)[0];
      const section = document.getElementById("milestonesSection");
      section.innerHTML = '';
      
      if (completed.length) {
        completed.forEach(c=>{
          const card = document.createElement('div');
          card.className = 'milestone-card';
          card.innerHTML = `
            <span class="milestone-label">Delivered</span>
            <div class="milestone-date">${c.name}</div>
            <span style="color:#004990; font-size:0.95em;">${c.date}</span>
            <span style="color:#4caf50; font-weight:700;">‚úì Completed</span>
          `;
          section.appendChild(card);
        });
      }
      
      if (maxIncomplete) {
        const card = document.createElement('div');
        card.className = 'milestone-card';
        card.innerHTML = `
          <span class="milestone-label">Highest Progress</span>
          <div class="milestone-date">${maxIncomplete.name}</div>
          <span style="color:#004990; font-size:0.95em;">${maxIncomplete.date}</span>
          <span style="color:#004990; font-weight:700;">${percent(maxIncomplete.progress)}</span>
        `;
        section.appendChild(card);
      }
      
      if (upcoming.length) {
        upcoming.forEach(c => {
          const card = document.createElement('div');
          card.className = 'milestone-card';
          card.innerHTML = `
            <span class="milestone-label">Upcoming Milestone</span>
            <div class="milestone-date">${c.name}</div>
            <span style="color:#004990; font-size:0.95em;">${c.date}</span>
            <span style="color:#ff9800; font-weight:700;">‚ö† Due Soon</span>
          `;
          section.appendChild(card);
        });
      }
    }

    // ==================== ANALYTICS FUNCTIONS ====================
    let analyticsView = 'all';
    
    function setAnalyticsView(view) {
      analyticsView = view;
      document.querySelectorAll('.analytics-toggle button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.toLowerCase() === view || (view === 'all' && btn.textContent === 'All')) {
          btn.classList.add('active');
        }
      });
      renderAnalytics();
    }
    
    function renderDonutChart(containerId, completed, total, color) {
      const container = document.getElementById(containerId);
      const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
      const circumference = 2 * Math.PI * 36;
      const offset = circumference - (percentage / 100) * circumference;
      
      container.innerHTML = `
        <div class="donut-chart">
          <svg width="90" height="90" viewBox="0 0 90 90">
            <circle class="donut-bg" cx="45" cy="45" r="36"></circle>
            <circle class="donut-progress" cx="45" cy="45" r="36" 
              stroke="${color}" 
              stroke-dasharray="${circumference}" 
              stroke-dashoffset="${offset}"></circle>
          </svg>
          <div class="donut-center">
            <div class="donut-value">${percentage}%</div>
            <div class="donut-label">Complete</div>
          </div>
        </div>
        <div class="donut-legend">
          <div class="legend-item">
            <div class="legend-dot" style="background: ${color};"></div>
            <span>Completed: ${completed}</span>
          </div>
          <div class="legend-item">
            <div class="legend-dot" style="background: #e8eef5;"></div>
            <span>Remaining: ${total - completed}</span>
          </div>
        </div>
      `;
    }
    
    function renderTimelineChart() {
      const container = document.getElementById('timelineChart');
      const startDate = new Date('2025-11-21');
      const endDate = new Date('2026-01-30');
      
      // Generate 7-day intervals
      const intervals = [];
      let current = new Date(startDate);
      while (current <= endDate) {
        intervals.push(new Date(current));
        current.setDate(current.getDate() + 7);
      }
      if (intervals[intervals.length - 1] < endDate) {
        intervals.push(new Date(endDate));
      }
      
      // Filter controls based on view
      let filteredControls = controls;
      if (analyticsView === 'reliance') {
        filteredControls = controls.filter(c => c.type === 'Reliance');
      } else if (analyticsView === 'independent') {
        filteredControls = controls.filter(c => c.type === 'Independent');
      }
      
      // Calculate expected and actual for each interval
      const expectedData = [];
      const actualData = [];
      
      intervals.forEach(intervalDate => {
        const dateStr = intervalDate.toISOString().split('T')[0];
        
        // Expected: cumulative count of controls with date <= interval date
        const expected = filteredControls.filter(c => c.date <= dateStr).length;
        expectedData.push(expected);
        
        // Actual: cumulative count of completed controls with date <= interval date
        const actual = filteredControls.filter(c => c.progress === 1 && c.date <= dateStr).length;
        actualData.push(actual);
      });
      
      const maxValue = Math.max(...expectedData, ...actualData, 1);
      const width = container.clientWidth || 400;
      const height = 180;
      const padding = { top: 20, right: 20, bottom: 35, left: 35 };
      const chartWidth = width - padding.left - padding.right;
      const chartHeight = height - padding.top - padding.bottom;
      
      // Generate points
      const getX = (i) => padding.left + (i / (intervals.length - 1)) * chartWidth;
      const getY = (val) => padding.top + chartHeight - (val / maxValue) * chartHeight;
      
      const expectedPoints = expectedData.map((val, i) => `${getX(i)},${getY(val)}`).join(' ');
      const actualPoints = actualData.map((val, i) => `${getX(i)},${getY(val)}`).join(' ');
      
      // Generate grid lines
      const gridLines = [];
      const yTicks = 4;
      for (let i = 0; i <= yTicks; i++) {
        const y = padding.top + (i / yTicks) * chartHeight;
        gridLines.push(`<line class="timeline-grid-line" x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}"></line>`);
        const val = Math.round(maxValue - (i / yTicks) * maxValue);
        gridLines.push(`<text class="timeline-axis-label" x="${padding.left - 8}" y="${y + 3}" text-anchor="end">${val}</text>`);
      }
      
      // Generate x-axis labels (show every other label to avoid crowding)
      const xLabels = intervals.map((date, i) => {
        if (i % 2 === 0 || i === intervals.length - 1) {
          const label = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          return `<text class="timeline-axis-label" x="${getX(i)}" y="${height - 8}" text-anchor="middle">${label}</text>`;
        }
        return '';
      }).join('');
      
      // Generate dots
      const expectedDots = expectedData.map((val, i) => 
        `<circle class="timeline-dot" cx="${getX(i)}" cy="${getY(val)}" r="3.5" fill="#004990"></circle>`
      ).join('');
      
      const actualDots = actualData.map((val, i) => 
        `<circle class="timeline-dot" cx="${getX(i)}" cy="${getY(val)}" r="3.5" fill="#4caf50"></circle>`
      ).join('');
      
      container.innerHTML = `
        <svg class="timeline-svg" viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet">
          ${gridLines.join('')}
          ${xLabels}
          <polyline class="timeline-line" points="${expectedPoints}" stroke="#004990"></polyline>
          <polyline class="timeline-line" points="${actualPoints}" stroke="#4caf50"></polyline>
          ${expectedDots}
          ${actualDots}
        </svg>
      `;
    }
    
    function renderAnalytics() {
      // Reliance donut
      const relianceControls = controls.filter(c => c.type === 'Reliance');
      const relianceCompleted = relianceControls.filter(c => c.progress === 1).length;
      renderDonutChart('relianceDonut', relianceCompleted, relianceControls.length, '#004990');
      
      // Independent donut
      const independentControls = controls.filter(c => c.type === 'Independent');
      const independentCompleted = independentControls.filter(c => c.progress === 1).length;
      renderDonutChart('independentDonut', independentCompleted, independentControls.length, '#15b6e5');
      
      // Timeline chart
      renderTimelineChart();
    }
    
    // Resize handler for timeline chart
    window.addEventListener('resize', () => {
      renderTimelineChart();
    });
    // ==================== END ANALYTICS FUNCTIONS ====================

    document.getElementById("filters").addEventListener("input", ()=>{
      renderTable();
      renderMilestones();
    });

    renderSummary();
    renderTable();
    renderMilestones();
    renderAnalytics();
    renderObservations();
    updateSortIcon();

    window.updateControl = function(controlName, updates) {
      const control = controls.find(c => c.name === controlName);
      if (control) {
        if (updates.date) control.date = updates.date;
        if (updates.progress !== undefined) control.progress = updates.progress;
        if (updates.type) control.type = updates.type;
        saveControls();
        renderSummary(); renderTable(); renderMilestones(); renderAnalytics();
        console.log(`‚úì Updated: ${controlName}`);
      } else {
        console.error(`‚úó Control not found: ${controlName}`);
      }
    }
    
    window.updateControls = function(newControls){
      controls.length = 0;
      newControls.forEach(c=>controls.push(c));
      saveControls();
      renderSummary(); renderTable(); renderMilestones(); renderAnalytics();
      console.log(`‚úì Updated ${newControls.length} controls`);
    }
    
    window.getControls = function() {
      console.log(JSON.stringify(controls, null, 2));
      return controls;
    }
    
    window.resetToDefaults = function() {
      if (confirm('Are you sure you want to reset all data to default values? This cannot be undone.')) {
        controls.length = 0;
        defaultControls.forEach(c => controls.push({...c}));
        saveControls();
        renderSummary(); renderTable(); renderMilestones(); renderAnalytics();
        console.log('‚úì Reset to default data');
      }
    }
    
    window.openEditPanel = function(index) {
      const control = controls[index];
      document.getElementById('editIndex').value = index;
      document.getElementById('editName').value = control.name;
      document.getElementById('editType').value = control.type;
      document.getElementById('editDate').value = control.date;
      document.getElementById('editProgress').value = Math.round(control.progress * 100);
      document.getElementById('editPanel').style.display = 'block';
      document.getElementById('editOverlay').style.display = 'block';
    }
    
    window.closeEditPanel = function() {
      document.getElementById('editPanel').style.display = 'none';
      document.getElementById('editOverlay').style.display = 'none';
    }
    
    window.saveEdit = function() {
      const index = parseInt(document.getElementById('editIndex').value);
      controls[index].name = document.getElementById('editName').value;
      controls[index].type = document.getElementById('editType').value;
      controls[index].date = document.getElementById('editDate').value;
      controls[index].progress = parseInt(document.getElementById('editProgress').value) / 100;
      saveControls();
      renderSummary();
      renderTable();
      renderMilestones();
      renderAnalytics();
      closeEditPanel();
      console.log(`‚úì Updated and saved: ${controls[index].name}`);
    }
    
    // ==================== EXCEL FILE HANDLING ====================
    const EXCEL_FILE_NAME = 'SOX_Dashboard.xlsx';
    const SHEET_NAME = 'Controls';
    
    window.handleExcelFileSelect = function(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array', cellDates: true });
          
          const sheet = workbook.Sheets[SHEET_NAME];
          if (!sheet) {
            alert('Sheet "' + SHEET_NAME + '" not found in Excel file. Please make sure the sheet is named "Controls".');
            return;
          }
          
          const jsonData = XLSX.utils.sheet_to_json(sheet, { raw: false, dateNF: 'yyyy-mm-dd' });
          
          controls.length = 0;
          jsonData.forEach((row, index) => {
            controls.push({
              name: row['Control Name'] || '',
              type: row['Type'] || 'Reliance',
              date: parseExcelDate(row['Date']),
              progress: parseFloat(row['Progress']) || 0
            });
          });
          
          // Load Observations sheet if it exists
          const obsSheet = workbook.Sheets['Observations'];
          if (obsSheet) {
            const obsData = XLSX.utils.sheet_to_json(obsSheet, { raw: true });
            observations.length = 0;
            obsData.forEach(row => {
              // Support both old and new column names
              const control = row['Control Name'] || row['Control'] || '';
              const observation = row['Potential Observation'] || row['Observation'] || '';
              if (control && observation) {
                observations.push({
                  control: control,
                  observation: observation
                });
              }
            });
            saveObservations();
            console.log('‚úì Loaded ' + observations.length + ' observations from Excel');
          }
          
          saveControls();
          renderSummary();
          renderTable();
          renderMilestones();
          renderAnalytics();
          renderObservations();
          
          console.log('‚úì Loaded ' + controls.length + ' controls from Excel');
          
        } catch (error) {
          console.error('Error reading Excel:', error);
          alert('Error reading Excel file: ' + error.message);
        }
      };
      reader.readAsArrayBuffer(file);
      event.target.value = '';
    }
    
    function parseExcelDate(dateValue) {
      if (!dateValue) return '';
      if (dateValue instanceof Date) {
        return formatDateForExcel(dateValue);
      }
      if (typeof dateValue === 'string') {
        const parsed = new Date(dateValue);
        if (!isNaN(parsed.getTime())) {
          return formatDateForExcel(parsed);
        }
        return dateValue;
      }
      if (typeof dateValue === 'number') {
        const date = XLSX.SSF.parse_date_code(dateValue);
        return date.y + '-' + String(date.m).padStart(2, '0') + '-' + String(date.d).padStart(2, '0');
      }
      return '';
    }
    
    function formatDateForExcel(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return year + '-' + month + '-' + day;
    }
    
    window.downloadExcel = function() {
      if (controls.length === 0) {
        alert('No data to save.');
        return;
      }
      
      try {
        // Controls sheet
        const wsData = [['Control Name', 'Type', 'Date', 'Progress']];
        
        controls.forEach(control => {
          wsData.push([
            control.name,
            control.type,
            control.date ? new Date(control.date) : '',
            control.progress
          ]);
        });
        
        const newWorkbook = XLSX.utils.book_new();
        const worksheet = XLSX.utils.aoa_to_sheet(wsData);
        
        worksheet['!cols'] = [
          { wch: 70 },
          { wch: 15 },
          { wch: 12 },
          { wch: 10 }
        ];
        
        XLSX.utils.book_append_sheet(newWorkbook, worksheet, SHEET_NAME);
        
        // Observations sheet
        const obsData = [['Control Name', 'Potential Observation']];
        observations.forEach(obs => {
          obsData.push([obs.control, obs.observation]);
        });
        
        const obsWorksheet = XLSX.utils.aoa_to_sheet(obsData);
        obsWorksheet['!cols'] = [
          { wch: 40 },
          { wch: 120 }
        ];
        
        XLSX.utils.book_append_sheet(newWorkbook, obsWorksheet, 'Observations');
        
        XLSX.writeFile(newWorkbook, EXCEL_FILE_NAME);
        
        console.log('‚úì Excel file downloaded: ' + EXCEL_FILE_NAME);
        
      } catch (error) {
        console.error('Error saving Excel:', error);
        alert('Failed to save Excel file: ' + error.message);
      }
    }
    
    console.log("%cüìä SOX Dashboard - Enhanced Version with Persistent Storage", "color: #004990; font-size: 16px; font-weight: bold;");
    console.log("%cüíæ All changes are automatically saved to your browser!", "color: #4caf50; font-weight: bold;");
    console.log("%cüìÇ Click 'Load Excel' to import data from SOX_Dashboard.xlsx", "color: #15b6e5; font-weight: bold;");
    console.log("%cüíæ Click 'Save Excel' to export data to SOX_Dashboard.xlsx", "color: #15b6e5; font-weight: bold;");
    console.log("%cüéØ Click 'Edit' button in any row to update controls via UI", "color: #15b6e5; font-weight: bold;");
    console.log("%cüìà Click 'Progress' header to sort by completion percentage", "color: #15b6e5; font-weight: bold;");
    console.log("%cConsole commands:", "color: #15b6e5; font-weight: bold;");
    console.log('updateControl("AC7.2 Emergency ID Provisioning", {date: "2025-12-01", progress: 0.8})');
    console.log('updateControls([{name:"AC7.2 Emergency ID Provisioning", type:"Reliance", date:"2025-12-01", progress:0.8}])');
    console.log('getControls() // View current data');
    console.log('resetToDefaults() // Reset all data to original values');
  </script>
</body>
</html>
